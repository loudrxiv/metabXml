---
title: "MetabXML, Figure: Technique use by research goal"
author: Mark Maher Makram Ebeid-Attalla
output: html_document
---
# Libraries we use here in figure creation
```{r, echo=FALSE}
library(ggpubr)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(tidyr)
library(tidyverse)
library(ggthemes)     # For additional themes
library(ggalluvial)   # For Sankey diagrams
library(showtext)
library(readxl)
library(ggradar)
library(scales)       # muted() etc.
library(purrr)        # map() for functional loops
library(readxl)
library(tidyverse)
library(scales)       # For wrap_format()
```
# Creating a stacked barchart to visualize the breakdown of ML techniques used for different research goals
- Paths & sheet list
```{r}
excel_path   <- "metabolites-review/data/objectives-by-techniques.xlsx"
sheet_names  <- excel_sheets(excel_path)
goal_sheets  <- sheet_names[!grepl("^summary", sheet_names, ignore.case = TRUE)]
```
- Helpers to parse the excel sheets --- what we need is in `summary`
```{r}

# ── 2. Helper: read one sheet, return tidy tibble

read_goal <- function(sheet){

  raw <- read_excel(excel_path, sheet = sheet, col_names = TRUE, .name_repair = "unique")

  # Auto-detect columns
  cols <- names(raw)
  tech_idx  <- which(tolower(cols) %in% c("technique", "techniques", "method", "mlmethod"))
  count_idx <- which(tolower(cols) %in% c("count", "n", "number", "frequency"))

  if (length(tech_idx) != 1 || length(count_idx) != 1){
    tech_idx  <- 1
    count_idx <- 2
  }

  tibble(
    ResearchGoal = sheet,
    Technique    = raw[[tech_idx]],
    Count        = as.numeric(raw[[count_idx]])
  ) |>
    filter(!is.na(Technique), !is.na(Count)) |>
    group_by(ResearchGoal, Technique) |>
    summarise(Count = sum(Count, na.rm = TRUE), .groups = "drop")
}

# ── 3. Combine sheets & tidy factors

all_goals <- map_dfr(goal_sheets, read_goal)

## order bars by total counts
goal_order <- all_goals |>
  group_by(ResearchGoal) |>
  summarise(Total = sum(Count), .groups = "drop") |>
  arrange(desc(Total)) |>
  pull(ResearchGoal)

## order techniques by frequency
tech_order <- all_goals |>
  group_by(Technique) |>
  summarise(Total = sum(Count), .groups = "drop") |>
  arrange(desc(Total)) |>
  pull(Technique)

all_goals <- all_goals |>
  mutate(
    ResearchGoal = factor(ResearchGoal, levels = goal_order),
    Technique    = factor(Technique,    levels = tech_order)
  )

# ── 4.  Wrapping long labels (axis + legend)

wrap_goal   <- wrap_format(25)   # 25-char line length for x-axis
wrap_leg    <- wrap_format(28)   # 28-char line length for legend

all_goals <- all_goals |>
  mutate(
    #Goal_lbl     = wrap_goal(ResearchGoal),
    Technique_lbl= wrap_leg(Technique)
  )

# ── 5.  Palette long enough for all techniques

n_tech <- n_distinct(all_goals$Technique_lbl)
base_pal <- c(
  "#999999", "#E69F00", "#56B4E9", "#009E73",
  "#F0E442", "#0072B2", "#D55E00", "#CC79A7",
  "#8B4513", "#B07AA1"
)
cbPalette <- if (n_tech <= length(base_pal)) {
  base_pal[1:n_tech]
} else {
  colorRampPalette(base_pal)(n_tech)
}
names(cbPalette) <- levels(all_goals$Technique_lbl)

# ── 6.  Publication-quality stacked bar

p <- ggplot(
  all_goals,
  aes(x = ResearchGoal, y = Count, fill = Technique_lbl)
) +
  geom_col(width = .7, colour = "grey92") +
  scale_fill_manual(values = cbPalette) +
  labs(
    x    = NULL,
    y    = "Number of occurrences",
    fill = "ML technique",
    title = "Machine-learning technique use by research goal"
  ) +
  theme_minimal(base_family = "Helvetica", base_size = 10) +
  theme(
    axis.text.x       = element_text(angle = 45, hjust = 1, vjust = 1, lineheight = 0.9),
    plot.margin       = margin(t = 10, r = 10, b = 80, l = 10),
    axis.title.x      = element_text(margin = margin(t = 20)),
    panel.grid.major.x= element_blank(),
    panel.grid.minor  = element_blank(),
    panel.grid.major.y= element_line(colour = "grey85", linewidth = .3),
    axis.line         = element_line(colour = "black"),
    plot.title        = element_text(face = "bold", hjust = .5, size = 12),
    legend.title      = element_text(face = "bold")
  )

print(p)

```
```{r}

# ── 7.  Vector export 

ggsave(
  "metabolites-review/figures/ML_techniques_by_goal_stackedbar.pdf",
  plot = p,
  width = 18,
  height = 11,
  units = "cm",
  device = cairo_pdf
)

```