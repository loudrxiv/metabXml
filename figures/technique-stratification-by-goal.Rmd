---
title: "MetabXML, Figure: Technique use by research goal"
author: Mark Maher Makram Ebeid-Attalla
output: html_document
---
# Libraries we use here in figure creation
```{r, echo=FALSE}
library(ggplot2)
library(readxl)
library(dplyr)
library(tidyr)
library(scales)
library(stringr)
library(purrr)
```
# Read in data from pertinent sheet in the datasets
```{r}
excel_path <- "metabXml/data/datasets.xlsx"
sheet      <- "technique-by-objective"

# Read and process the table
raw <- as.data.frame(read_excel(excel_path, sheet=sheet, col_names = TRUE))
rownames(raw) <- raw[[1]]
raw           <- raw[, -1]
```
# Manipulate the data
```{r}
df <- raw |> # tibble to pivot_longer
  tibble::rownames_to_column("Technique") |>
  pivot_longer(
    cols = -Technique,
    names_to = "ResearchGoal",
    values_to = "Count"
  ) |>
  mutate(Count = as.numeric(Count)) |>
  filter(!is.na(Count), Count > 0)

# Init order 
goal_order <- df |>
  group_by(ResearchGoal) |>
  summarise(Total = sum(Count), .groups = "drop") |>
  arrange(desc(Total)) |>
  pull(ResearchGoal)

tech_order <- df |>
  group_by(Technique) |>
  summarise(Total = sum(Count), .groups = "drop") |>
  arrange(desc(Total)) |>
  pull(Technique)

df <- df |> # make it nice
  mutate(
    ResearchGoal = factor(ResearchGoal, levels = goal_order),
    Technique    = factor(Technique, levels = tech_order)
  )

# Our labels are long
# wrap_goal <- scales::wrap_format(20)
# wrap_leg  <- scales::wrap_format(28)

df <- df |>
  mutate(
    # Goal_lbl      = wrap_goal(as.character(ResearchGoal)),
    # Technique_lbl = wrap_leg(as.character(Technique))
    Goal_lbl      = as.character(ResearchGoal),
    Technique_lbl = as.character(Technique)
  )

df <- df |>
  mutate(
    Goal_lbl      = factor(Goal_lbl, levels = unique(Goal_lbl[order(ResearchGoal)])),
    #Technique_lbl = factor(Technique_lbl, levels = wrap_leg(tech_order))
    Technique_lbl = factor(Technique_lbl, levels = tech_order)
  )

# I need to not run out of colors for the stacked bars
base_pal <- c(
  "#999999", "#E69F00", "#56B4E9", "#009E73",
  "#F0E442", "#0072B2", "#D55E00", "#CC79A7",
  "#8B4513", "#B07AA1", "#66C2A5", "#FC8D62",
  "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F"
)
n_tech <- nlevels(df$Technique_lbl)
fill_pal <- if (n_tech <= length(base_pal)) base_pal[1:n_tech] else colorRampPalette(base_pal)(n_tech)
names(fill_pal) <- levels(df$Technique_lbl)

if (requireNamespace("showtext", quietly = TRUE)) {
  library(showtext)
  showtext_auto(enable = TRUE)
}
```
# Create the plot
```{r}
p <- ggplot(df, aes(x = Goal_lbl, y = Count, fill = Technique_lbl)) +
  geom_col(width = 0.6, color = "grey85", linewidth = 0.3) +
  scale_fill_manual(values = fill_pal, name = NULL) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    breaks = seq(0, 12, by = 2)
  ) +
  
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  
  labs(
    x = NULL,
    y = "Number of occurrences",
    title = "Machine-learning technique use by research goal"
  ) +
  
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(
      face = "bold", 
      hjust = 0.5, 
      size = 22,
      margin = margin(b = 25) # more space below title
    ),
    
    axis.title.y = element_text(
      size = 16,
      face = "bold", 
      color = "grey20",
      margin = margin(r = 15) # space between title and labels
    ),
    
    axis.text.y = element_text(size = 14, color = "grey20"),
    axis.text.x = element_text(
      size = 14,
      color = "grey20",
      angle = 90,     # rotate 90 degrees for readability
      hjust = 1,      # align to the axis line
      vjust = 0.5     # center on the tick mark
    ),
    
    legend.text = element_text(size = 14, lineheight = 1.1),
    legend.key.size = unit(16, "pt"), # Use key.size for square keys
    legend.spacing.y = unit(6, "pt"),
    legend.position = "right",    
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_line(color = "grey88", linewidth = 0.4),    
    axis.line = element_line(color = "grey70", linewidth = 0.4),
    axis.ticks = element_line(color = "grey70", linewidth = 0.4),
    axis.ticks.length = unit(4, "pt"),    
    plot.margin = margin(t = 20, r = 25, b = 20, l = 20),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  ) +
  
  guides(fill = guide_legend(ncol = 1, byrow = TRUE, reverse = TRUE))

print(p)
```
# Save the plot
```{r}
# Should already exist, but just in case
dir.create("metabXml/figures", showWarnings=FALSE, recursive=TRUE)

ggsave( # PDF
  filename = "metabXml/figures/Fig_technique-stratification-by-goal.pdf",
  plot = p, width = 12, height = 6.5, units = "in", device = cairo_pdf
)

ggsave( # PNG
  filename = "metabXml/figures/Fig_technique-stratification-by-goal.png",
  plot = p, width = 12, height = 6.5, units = "in",
  bg = "white", dpi = 600
)

if (requireNamespace("svglite", quietly = TRUE)) { # SVG
  svglite::svglite(
    file = "metabXml/figures/Fig_technique-stratification-by-goal.svg",
    width = 12, height = 6.5, bg = "white"
  )
  print(p)
  dev.off()
}
```