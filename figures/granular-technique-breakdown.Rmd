---
title: "MetabXML, Figure: Breakdown exactly which techniques are used"
author: Mark Maher Makram Ebeid-Attalla
output: html_document
---
# Libraries we use here in figure creation
```{r}
library(ggpubr)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(tidyr)
library(tidyverse)
library(ggthemes)   # For additional themes
library(ggalluvial) # For Sankey diagrams
library(showtext)
library(readxl)
library(ggradar)
library(scales)      # muted() etc.
library(purrr)       # map() for functional loops
library(readxl)
library(tidyverse)
library(ggalluvial)
library(scales)      # wrap_format()
```
# Read in data from pertinent sheet in the datasets
- Define file path and sheet name
```{r}
excel_path <- "metabXml/data/datasets.xlsx"
sheet      <- "technique-breakdown"
```
```{r}
raw <- read_excel(excel_path, sheet=sheet, .name_repair="unique")

# It's messy, but since the formatting makes it so 
# the headers will be NA, we can use that to our advantage.
clean <- raw %>%
  mutate(Category = if_else(is.na(Count),
                            `Machine Learning Technique`, NA_character_)) %>%
  fill(Category) %>%
  filter(!is.na(Count))
```
# Manipulate the data
```{r}
# We create 'other' for techniques used in <2 studies to reduce clutter
edge_tbl <- clean %>%
  group_by(Category, Method = `Machine Learning Technique`) %>%
  summarise(Count = sum(Count), .groups = "drop") %>%
  mutate(
    Method = if_else(Count < 2, "Other (<2)", Method)
  ) %>%                                   # re-count because of lumping
  group_by(Category, Method) %>%
  summarise(Count = sum(Count), .groups = "drop")

# We want order
cat_order <- edge_tbl %>%
  group_by(Category) %>% summarise(Total = sum(Count)) %>%
  arrange(desc(Total)) %>% pull(Category)

met_order <- edge_tbl %>%
  group_by(Method) %>% summarise(Total = sum(Count)) %>%
  arrange(desc(Total)) %>% pull(Method)

edge_tbl <- edge_tbl %>%
  mutate(
    Category = factor(Category, levels = cat_order),
    Method   = factor(Method,   levels = met_order)
  )

# Getting this to look nice is SO annoying
break_vec <- c(
  "Dimensionality Reduction and Feature Extraction" =
    "Dimensionality\nReduction\nand Feature Extraction",
  "General Purpose and Ensemble Models" =
    "General Purpose\nand Ensemble Models",
  "Other Statistical and Graphical Methods" =
    "Other Statistical\nand Graphical Methods",
  "Principal Component Analysis"="PCA",
  "Linear Mixed-Effects Models"="LMM",
  "Mixed Graphical Models"="MGM",
  "Uniform Nanifold Approximation and Projection"="UMAP",
  "Gaussian Mixture Models"="GMM",
  "Parallel Factor Analysis"="PARAFAC"
)

edge_tbl <- edge_tbl %>%
  mutate(
    Category_lbl = recode(as.character(Category), !!!break_vec),
    Method_lbl   = recode(as.character(Method),   !!!break_vec)
  )

p <- ggplot(edge_tbl,
            aes(axis1 = Category_lbl,
                axis2 = Method_lbl,
                y     = Count)) +

  # flows
  geom_alluvium(aes(fill = Category),
                width = 8/100, colour = "grey40", alpha = 1, knot.pos = 0.3) +

  # strata
  geom_stratum(width = 30/100, colour = "grey40", fill = "white") +

  # ──  label block
  geom_text(stat  = "stratum",
            aes(label = after_stat(stratum)),
            fontface = "bold",
            size = 3.6,                     # adjust if you need larger/smaller
            colour = "black",
            hjust = 0.5, vjust = 0.5) +     # centres text inside the stratum

  scale_x_discrete(limits = c("ML category", "ML technique"),
                   expand = expansion(mult = 0.30)) +

  scale_fill_brewer(palette = "Set3", guide = "none") +

  scale_y_continuous(expand = expansion(mult = c(0.02, 0.05))) +

  labs(
    #title = "Figure E | Machine-learning techniques used per analysis category",
    y = "Number of studies"
  ) +

  theme_void(base_family = "Helvetica", base_size = 11) +
  theme(
    plot.title  = element_text(face = "bold", hjust = .5, size = 13),
    plot.margin = margin(15, 60, 15, 60)   # extra room for labels
  )

print(p)
```
# Save the plot
```{r}
# Should already exist, but just in case
dir.create("metabXml/figures", showWarnings=FALSE, recursive=TRUE)

ggsave( # PDF
  filename = "metabXml/figures/Fig_granular-technique-breakdown.pdf",
  plot = p, width = 12, height = 6.5, units = "in", device = cairo_pdf
)

ggsave( # PNG
  filename = "metabXml/figures/Fig_granular-technique-breakdown.png",
  plot = p, width = 12, height = 6.5, units = "in",
  bg = "white", dpi = 600
)

if (requireNamespace("svglite", quietly = TRUE)) { # SVG
  svglite::svglite(
    file = "metabXml/figures/Fig_granular-technique-breakdown.svg",
    width = 12, height = 6.5, bg = "white"
  )
  print(p)
  dev.off()
}
```